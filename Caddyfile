api.talentix.net {
    # Handle OPTIONS preflight requests - respond directly with CORS headers
    @options {
        method OPTIONS
    }
    handle @options {
        # List of allowed origins
        @allowed_origin {
            header Origin "https://admin.talentix.net"
        }
        @allowed_origin {
            header Origin "https://talentix.net"
        }
        @allowed_origin {
            header Origin "https://talynk.vercel.app"
        }
        @allowed_origin {
            header Origin "https://talynk-management.vercel.app"
        }
        @allowed_origin {
            header Origin "https://talynk-test.vercel.app"
        }
        @allowed_origin {
            header Origin "https://talynk-user-frontend-production.up.railway.app"
        }
        @allowed_origin {
            header Origin "https://talynk-user-frontend-git-main-ihirwepatricks-projects.vercel.app"
        }
        @allowed_origin {
            header Origin "http://localhost:5173"
        }
        @allowed_origin {
            header Origin "http://localhost:3000"
        }
        @allowed_origin {
            header Origin "http://localhost:3001"
        }
        
        handle @allowed_origin {
            header Access-Control-Allow-Origin "{http.request.header.Origin}"
            header Access-Control-Allow-Credentials "true"
            header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH"
            header Access-Control-Allow-Headers "Content-Type, Authorization, Origin, X-Requested-With, Accept, Access-Control-Allow-Headers"
            header Access-Control-Max-Age "86400"
            respond 204
        }
        
        # Default response for OPTIONS (shouldn't reach here if origin is valid)
        respond 204
    }

    # Handle all other requests - forward to backend
    reverse_proxy http://localhost:3000 {
        # Preserve original host
        header_up Host {host}
        
        # Forward client information (important for trust proxy in Express)
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
        
        # Ensure Origin header is passed through (critical for CORS)
        header_up Origin {http.request.header.Origin}
    }

    # Gzip compression
    encode gzip

    # Logging
    log {
        output file /var/log/caddy/api.access.log
    }
}

